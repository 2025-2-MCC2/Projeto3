<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/png" href="./public/logos/liderancas-empaticas.png" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestão de Lideranças</title>
    <!-- React 18 UMD + Babel Standalone (dev) -->
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
    <!-- Runtime ENV (copie env.js.example para env.js e ajuste API_URL) -->
    <script src="./env.js"></script>
    <style>
      :root {
        --green: #1f9d74;
        --green-dark: #0b6046;
        --green-neon: #4df2c2;
        --bg-hero: radial-gradient(circle at 10% 20%, rgba(77, 242, 194, 0.22), rgba(12, 27, 16, 0)), linear-gradient(160deg, rgba(6, 17, 12, 0.92) 0%, #04120c 38%, #051b12 100%);
        --card-bg: rgba(255,255,255,0.08);
        --card-border: rgba(255,255,255,0.08);
        --glass-blur: saturate(160%) blur(18px);
        --text-primary: #e9fef6;
        --text-muted: rgba(233, 254, 246, 0.62);
        --shadow-soft: 0 24px 80px rgba(5, 20, 14, 0.28);
      }
      *, *::before, *::after {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: #040d09;
        font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial;
        color: var(--text-primary);
        min-height: 100vh;
        background-image: url('https://www.transparenttextures.com/patterns/asfalt-dark.png');
        overflow-x: hidden;
      }
      header {
        position: sticky;
        top: 0;
        z-index: 1000;
        background: rgba(4, 18, 12, 0.85);
        backdrop-filter: blur(16px);
        border-bottom: 1px solid rgba(77, 242, 194, 0.18);
        padding: 18px 36px;
        display:flex;
        justify-content: space-between;
        align-items:center;
        font-family: 'Montserrat', sans-serif;
        font-weight:700;
        letter-spacing: 0.8px;
      }
      header span:first-child {
        font-size: 20px;
        display:flex;
        align-items:center;
      }
      .header-actions {
        display:flex;
        gap:16px;
        align-items:center;
      }
      .container {
        max-width: 1240px;
        margin: 0 auto;
        padding: 24px;
        display: grid;
        gap: 20px;
      }
      .grid-2 {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 20px;
      }
      @media (max-width: 900px) { .grid-2 { grid-template-columns: 1fr; } }
      .card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 20px;
        padding: 20px;
        box-shadow: var(--shadow-soft);
        backdrop-filter: var(--glass-blur);
        position: relative;
        overflow: hidden;
      }
      .card::after {
        content: '';
        position: absolute;
        inset: 1px;
        border-radius: 18px;
        border: 1px solid rgba(77, 242, 194, 0.06);
        pointer-events: none;
      }
      .btn {
        background: linear-gradient(135deg, var(--green) 0%, var(--green-neon) 100%);
        color:#05130c;
        border:none;
        padding:10px 16px;
        border-radius:12px;
        cursor:pointer;
        font-weight:600;
        letter-spacing:0.4px;
        box-shadow: 0 14px 30px rgba(26, 177, 122, 0.35);
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap:8px;
        text-decoration:none;
      }
      .btn:active {
        transform: translateY(1px);
      }
      /* Modern dashboards: utilities */
      .grid-auto { display:grid; grid-template-columns: repeat(12, minmax(0,1fr)); gap:16px; }
      .col-3 { grid-column: span 3; }
      .col-4 { grid-column: span 4; }
      .col-6 { grid-column: span 6; }
      .col-8 { grid-column: span 8; }
      .col-12 { grid-column: 1 / -1; }
      @media (max-width: 1200px){ .col-3{grid-column: span 6;} .col-4{grid-column: span 6;} .col-6{grid-column: span 12;} .col-8{grid-column: span 12;} }
      @media (max-width: 900px){ .col-3{grid-column: span 12;} .col-4{grid-column: span 12;} }
      .badge {
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:6px 12px;
        border-radius:999px;
        font-size:12px;
        background: rgba(77, 242, 194, 0.12);
        color: var(--green-neon);
        border:1px solid rgba(77, 242, 194, 0.3);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .chip {
        padding:6px 12px;
        border-radius:999px;
        background: rgba(255,255,255,0.08);
        color: var(--text-primary);
        font-size:12px;
        border:1px solid rgba(255,255,255,0.08);
      }
      .risk-badge {
        display:inline-flex;
        align-items:center;
        gap:8px;
        border-radius:999px;
        padding:4px 10px;
        font-size:11px;
        letter-spacing:0.4px;
        text-transform:uppercase;
        background: rgba(255,255,255,0.06);
        border:1px solid rgba(255,255,255,0.08);
      }
      .risk-badge svg { width:14px; height:14px; }
      .risk-low { color:#4df2c2; border-color:rgba(77, 242, 194, 0.4); background: rgba(77, 242, 194, 0.08); }
      .risk-medium { color:#ffd45f; border-color:rgba(255,212,95,0.45); background: rgba(255,212,95,0.12); }
      .risk-high { color:#ff7b7b; border-color:rgba(255,123,123,0.4); background: rgba(255,123,123,0.12); box-shadow:0 0 14px rgba(255,123,123,0.18); }
      .audit-timeline {
        display:flex;
        flex-direction:column;
        gap:12px;
        margin-top:12px;
      }
      .audit-timeline-item {
        display:grid;
        grid-template-columns: 18px 1fr;
        gap:12px;
        align-items:start;
      }
      .audit-timeline-item span {
        font-size:12px;
        color: rgba(233,254,246,0.65);
      }
      .audit-icon {
        width:18px;
        height:18px;
        border-radius:50%;
        background: rgba(77,242,194,0.16);
        border:1px solid rgba(77,242,194,0.42);
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:10px;
        color:var(--green-neon);
      }
      .audit-divider {
        height:1px;
        background:rgba(77,242,194,0.12);
      }
      .muted { color: var(--text-muted); }
      .subtitle {
        color:#f0fff8;
        font-weight:700;
        letter-spacing:0.6px;
        text-transform: uppercase;
        font-size: 13px;
      }
      .btn-full { width:100%; }
      .login-wrapper {
        min-height: 100vh;
        background: var(--bg-hero);
        padding: 48px 20px;
        display:flex;
        align-items:center;
        justify-content:center;
        position:relative;
        overflow:hidden;
      }
      .login-wrapper::before,
      .login-wrapper::after {
        content:'';
        position:absolute;
        border-radius: 50%;
        filter: blur(120px);
        opacity:0.35;
        pointer-events:none;
      }
      .login-wrapper::before {
        width: 420px;
        height: 420px;
        background: rgba(77, 242, 194, 0.35);
        top: -120px;
        right: -160px;
      }
      .login-wrapper::after {
        width: 360px;
        height: 360px;
        background: rgba(31, 157, 116, 0.32);
        bottom: -140px;
        left: -140px;
      }
      .login-card {
        width: 100%;
        max-width: 520px;
        padding: 48px 42px;
        background: rgba(4, 18, 12, 0.9);
        border: 1px solid rgba(77, 242, 194, 0.2);
        box-shadow: 0 40px 120px rgba(0, 0, 0, 0.55);
        backdrop-filter: blur(22px);
      }
      .login-header {
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        gap:18px;
        margin-bottom: 32px;
        text-align:center;
      }
      .login-logos {
        display:flex;
        gap:24px;
        align-items:center;
        justify-content:center;
      }
      .login-logos img {
        height: 78px;
        width: 78px;
        object-fit: contain;
        padding: 0;
        border-radius: 0;
        background: transparent;
        border: none;
        box-shadow: none;
      }
      .login-title {
        text-align:center;
        margin-bottom: 0;
        font-size: 30px;
        font-weight: 800;
        color: #f4fff8;
        letter-spacing: 0.8px;
        max-width: 420px;
        line-height: 1.25;
      }
      .login-subtitle {
        font-size: 16px;
        letter-spacing: 0.8px;
        color: rgba(233, 254, 246, 0.68);
      }
      .login-form {
        display:grid;
        gap:16px;
      }
      .login-form .input {
        border-radius: 16px;
        padding: 16px 22px;
        width: 100%;
        box-sizing: border-box;
      }
      .login-error {
        color: #ff6b6b;
        text-align: center;
        font-size: 0.92rem;
        letter-spacing: 0.3px;
      }
      .login-form select.input {
        appearance: none;
        padding-right: 48px;
        background-image:
          linear-gradient( to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 60%, rgba(0,0,0,0.18) 100%),
          url('data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%234df2c2" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"%3E%3Cpolyline points="6 9 12 15 18 9"/%3E%3C/svg%3E');
        background-position: 0 0, calc(100% - 18px) 50%;
        background-size: 100% 100%, 18px 18px;
        background-repeat: no-repeat;
      }
      .login-actions {
        margin-top: 20px;
        display:grid;
        gap:14px;
      }
      .login-switch {
        text-align:center;
      }
      .login-switch .btn {
        border-radius:12px;
        border:1px solid rgba(77, 242, 194, 0.28);
        background: rgba(4, 18, 12, 0.65);
        color: var(--green-neon);
        box-shadow: 0 18px 40px rgba(77, 242, 194, 0.16);
      }
      .login-switch .btn:hover {
        background: rgba(77, 242, 194, 0.18);
        color: #05130c;
      }
      .divider { height:1px; background:#eef1f3; margin:8px 0; }
      .btn-sm { padding:6px 10px; border-radius:999px; font-size: 0.92rem; }
      .btn-ghost {
        background:rgba(77, 242, 194, 0.08);
        color: var(--green-neon);
        border:1px solid rgba(77, 242, 194, 0.3);
      }
      .btn-ghost:hover { background: rgba(77, 242, 194, 0.16); }
      .btn-danger {
        background: linear-gradient(135deg, #f15f79 0%, #b24592 100%);
        color:#fff;
        box-shadow: 0 10px 24px rgba(188, 69, 146, 0.35);
      }
      .input {
        padding:12px 14px;
        border:1px solid rgba(77, 242, 194, 0.12);
        border-radius:12px;
        width:100%;
        background: rgba(4, 18, 12, 0.84);
        color: var(--text-primary);
        box-shadow: inset 0 0 0 1px rgba(77, 242, 194, 0.04);
        transition: border-color .2s ease, box-shadow .2s ease, transform .2s ease;
      }
      .input:focus {
        outline:none;
        border-color: rgba(77, 242, 194, 0.45);
        box-shadow: 0 0 0 4px rgba(77, 242, 194, 0.12);
        transform: translateY(-1px);
      }
      table {
        width:100%;
        border-collapse: collapse;
        color: inherit;
      }
      th, td {
        padding:12px 10px;
        text-align:left;
      }
      thead tr {
        background: rgba(12, 26, 18, 0.7);
        border-bottom: 1px solid rgba(77, 242, 194, 0.14);
      }
      tbody tr {
        border-top: 1px solid rgba(77, 242, 194, 0.08);
      }
      .linha-selecionada { background-color: #d1ecf1; font-weight: bold; }
      button:disabled { opacity: 0.5; cursor: not-allowed; }
      /* Animations */
      @keyframes fadeInUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes scaleIn { from { opacity: 0; transform: scale(.96); } to { opacity: 1; transform: scale(1); } }
      .anim-fade { animation: fadeInUp .5s ease both; }
      .anim-scale { animation: scaleIn .4s ease both; }
      /* Auth styles */
      .auth-bg {
        background: var(--bg-hero);
      }
      .auth-grid {
        display:grid;
        grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
        gap: 0;
        width:100%;
        max-width: 1060px;
        border-radius: 26px;
        overflow: hidden;
        box-shadow: 0 40px 120px rgba(0,0,0,0.45);
      }
      .auth-col-illustration {
        display:none;
        background: linear-gradient(200deg, rgba(77, 242, 194, 0.24), rgba(4, 15, 10, 0.9));
        padding:48px;
        position:relative;
      }
      .auth-col-illustration::after {
        content:'';
        position:absolute;
        inset:24px;
        border-radius: 38px;
        border: 1px solid rgba(77, 242, 194, 0.2);
        opacity:0.6;
      }
      .auth-card {
        background: rgba(4, 18, 12, 0.82);
        border:1px solid rgba(77, 242, 194, 0.16);
        padding:48px 40px;
        backdrop-filter: blur(16px);
      }
      @media (min-width: 960px){ .auth-col-illustration{display:block;} }
      .input-group { position: relative; }
      .input-icon { position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#6c757d; }
      .input.has-icon { padding-left:34px; }
      .link-ghost { background:transparent; color: var(--green); border:none; cursor:pointer; padding:6px 8px; border-radius:8px; }
      .link-ghost:hover { background: rgba(25,135,84,.06); }
      .text-center { text-align:center; }
      .row { display:flex; gap:12px; align-items:center; justify-content:space-between; }
      .help { font-size:12px; color:#6c757d; }
      /* New animations and smooth interactions */
      @keyframes slideIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes popIn { from { opacity: 0; transform: scale(.92); } to { opacity: 1; transform: scale(1); } }
      .anim-slide { animation: slideIn .5s ease both; }
      .anim-pop { animation: popIn .35s ease both; }
      .reveal { opacity: 0; transform: translateY(10px); }
      .reveal.in-view { opacity: 1; transform: none; transition: opacity .5s ease, transform .5s ease; }

      .card { transition: transform .2s ease, box-shadow .2s ease; }
      .card:hover { transform: translateY(-2px); box-shadow: 0 10px 28px rgba(0,0,0,.08); }
      .btn { transition: transform .15s ease, box-shadow .15s ease, background-color .2s ease; }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 45px rgba(77, 242, 194, 0.4);
      }
      tbody tr { transition: background-color .2s ease, transform .15s ease; }
      tbody tr:hover {
        transform: translateY(-1px);
        background: rgba(77, 242, 194, 0.04);
      }

      @media (prefers-reduced-motion: reduce) {
        * { animation: none !important; transition: none !important; }
      }

      /* Mobile-first enhancements (only phones/tablets) */
      @media (max-width: 768px) {
        body { font-size: 15px; }
        header {
          padding: 14px 18px;
          flex-direction: column;
          align-items: flex-start;
          gap: 12px;
        }
        header span:first-child { font-size: 18px; }
        .header-actions {
          width: 100%;
          justify-content: space-between;
          flex-wrap: wrap;
          gap: 10px;
        }
        .container { padding: 18px; }
        .card { padding: 18px; border-radius: 18px; }
        .login-wrapper { padding: 36px 18px; }
        .login-card { padding: 36px 28px; }
        .login-header { gap:16px; margin-bottom:24px; }
        .login-logos { gap:18px; }
        .login-logos img { height:64px; width:64px; }
        .login-title { font-size: 26px; }
        .login-subtitle { font-size: 14px; }
        .login-form { gap:14px; }
        .login-form .input { padding: 15px 18px; }
        .login-actions { gap:12px; }
        .grid-auto { grid-template-columns: 1fr; gap: 12px; }
        .col-3, .col-4, .col-6, .col-8, .col-12 { grid-column: 1 / -1; }
        table { font-size: 14px; table-layout: fixed; }
        th, td { padding: 6px; white-space: nowrap; }
        .btn { padding: 10px 12px; border-radius: 10px; }
        .auth-logo-lg { height: 44px !important; }
        .auth-logo-sm { height: 36px !important; }
        /* Inputs larger to avoid iOS zoom */
        .input { font-size: 16px; }
        /* Collapse multi-column forms */
        form[style*='grid-template-columns:repeat(4'] { grid-template-columns: 1fr !important; }
        form[style*='grid-template-columns:repeat(3'] { grid-template-columns: 1fr !important; }
        /* Compact previews */
        img[alt^='Foto '] { width: 56px !important; height: 56px !important; }
      }

      @media (max-width: 540px) {
        header span:first-child { font-size: 17px; }
        .header-actions { justify-content: flex-start; }
        .login-wrapper { padding: 28px 16px; }
        .login-card { padding: 30px 22px; }
        .login-logos { gap:14px; }
        .login-logos img { height:58px; width:58px; }
        .login-title { font-size: 22px; }
        .login-subtitle { font-size: 13px; letter-spacing: 0.5px; }
        .login-form .input { padding: 14px 16px; }
        .btn { width: 100%; }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="text/babel">
      const { useState, useEffect } = React;

      function Header({ title, user, onLogout }) {
        return (
          <header>
            <span>{title}</span>
            <div className="header-actions">
              {user && <span style={{opacity:.95}}>{(user.role || 'USUÁRIO').toUpperCase()} - {user.name || 'Sessão'}</span>}
              {user && <button className="btn" onClick={onLogout}>Sair</button>}
            </div>
          </header>
        );
      }

      // === Storage simples para doações (simula fluxo original) ===
      const LS_KEYS = {
        DONATIONS: 'gl_donations',
        PENDING: 'gl_donations_pending',
        RECENT: 'gl_donations_recent',
        AUDIT: 'gl_donations_audit'
      };
      function lsGet(key, fallback=[]) { try { return JSON.parse(localStorage.getItem(key) || JSON.stringify(fallback)); } catch { return fallback; } }
      function lsSet(key, value) { localStorage.setItem(key, JSON.stringify(value)); }

      function hashString(str='') {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          hash = ((hash << 5) - hash) + str.charCodeAt(i);
          hash |= 0;
        }
        return Math.abs(hash);
      }

      function fingerprintsFromPhotos(photos=[]) {
        return photos.map((src, idx) => {
          const sample = (src || '').slice(0, 120) + (src || '').slice(-60);
          return `${hashString(sample)}-${idx}`;
        });
      }

      function buildAuditEvent(donation, action, actor, extra={}) {
        return {
          id: `${donation.id}-${Date.now()}-${Math.random().toString(16).slice(2)}`,
          donationId: donation.id,
          action,
          actor,
          timestamp: new Date().toISOString(),
          extra
        };
      }

      function pushAuditEvents(events=[]) {
        if (!events.length) return;
        if (events.length === 1 && events[0] == null) return;
        const list = lsGet(LS_KEYS.AUDIT);
        events.filter(Boolean).forEach(ev => list.unshift(ev));
        if (list.length > 200) list.splice(200);
        lsSet(LS_KEYS.AUDIT, list);
      }

      function listAuditTrail(limit=50) {
        return lsGet(LS_KEYS.AUDIT).slice(0, limit);
      }

      function computeRiskScore({ donation, userHistory=[] }) {
        let score = 0;
        const amount = donation.amount || 0;
        if (donation.category === 'fundos' && amount > 500) score += 6;
        else if (donation.category === 'fundos' && amount > 200) score += 4;
        if (donation.category !== 'fundos' && amount > 40) score += 2;
        const now = Date.now();
        const created = new Date(donation.createdAt || Date.now()).getTime();
        if (now - created < 5 * 60 * 1000) score += 1; // envio muito rápido
        if (!donation.photos || donation.photos.length < 2) score += 2;
        const duplicates = fingerprintsFromPhotos(donation.photos);
        const dupCount = userHistory.reduce((acc, prev) => {
          const prevPrints = prev.fingerprints || [];
          if (prev.id === donation.id) return acc;
          const intersection = prevPrints.filter(p => duplicates.includes(p));
          return intersection.length ? acc + 1 : acc;
        }, 0);
        score += dupCount * 5;
        return score;
      }

      function mapRisk(score=0) {
        if (score >= 10) return { level: 'Alto', className: 'risk-high' };
        if (score >= 5) return { level: 'Médio', className: 'risk-medium' };
        return { level: 'Baixo', className: 'risk-low' };
      }

      function normalizeDonationList(list=[]) {
        const cloned = list.map(d => ({ ...d }));
        const byUser = {};
        cloned.forEach(d => {
          if (!Array.isArray(d.photos)) d.photos = [];
          if (!Array.isArray(d.fingerprints) || d.fingerprints.length === 0) {
            d.fingerprints = fingerprintsFromPhotos(d.photos);
          }
          const key = d.user?.name || '__';
          byUser[key] = byUser[key] || [];
          byUser[key].push(d);
        });
        Object.values(byUser).forEach(items => {
          items.sort((a,b)=> new Date(a.createdAt || a.updatedAt || 0) - new Date(b.createdAt || b.updatedAt || 0));
          items.forEach((d, idx) => {
            const history = items.filter((_, j) => j !== idx);
            const score = computeRiskScore({ donation: d, userHistory: history });
            const { level, className } = mapRisk(score);
            d.riskScore = score;
            d.riskLevel = level;
            d.riskClass = className;
            if (d.status === 'Pendente') {
              d.needsEvidence = d.needsEvidence || level === 'Alto';
            } else {
              d.needsEvidence = false;
            }
          });
        });
        return cloned;
      }

      function syncDonationCaches() {
        const normalized = normalizeDonationList(lsGet(LS_KEYS.DONATIONS));
        lsSet(LS_KEYS.DONATIONS, normalized);
        const byId = Object.fromEntries(normalized.map(d => [d.id, d]));
        const pendingRaw = lsGet(LS_KEYS.PENDING).map(d => ({ ...byId[d.id], ...d }));
        lsSet(LS_KEYS.PENDING, pendingRaw);
        const recentRaw = lsGet(LS_KEYS.RECENT).map(d => ({ ...byId[d.id], ...d }));
        lsSet(LS_KEYS.RECENT, recentRaw);
        return {
          normalized,
          pending: pendingRaw,
          recent: recentRaw
        };
      }

      function createDonation({ description, amount, category, unit, team, user, photos=[] }) {
        const all = lsGet(LS_KEYS.DONATIONS);
        const id = (all.reduce((m, d)=>Math.max(m, d.id||0), 0) + 1) || 1;
        const donation = {
          id,
          description,
          amount: parseFloat(amount||0),
          category,
          unit,
          team: team||'',
          user,
          photos,
          fingerprints: fingerprintsFromPhotos(photos),
          status: 'Pendente',
          createdAt: new Date().toISOString(),
          riskScore: 0,
          riskLevel: 'Baixo'
        };
        all.push(donation); lsSet(LS_KEYS.DONATIONS, all);
        const pend = lsGet(LS_KEYS.PENDING); pend.push(donation); lsSet(LS_KEYS.PENDING, pend);
        pushAuditEvents([buildAuditEvent(donation, 'Registrada', user?.name || 'Aluno', { description })]);
        const { normalized } = syncDonationCaches();
        return normalized.find(d => d.id === id) || donation;
      }
      function listPending() { return syncDonationCaches().pending; }
      function listRecent() { return syncDonationCaches().recent; }
      function listAllDonations() { return syncDonationCaches().normalized; }
      function listUserDonations(user) { const all = listAllDonations(); return all.filter(d => d.user?.name === user.name); }
      function updateDonationStatus(id, status, motivo=null) {
        const all = lsGet(LS_KEYS.DONATIONS); const idx = all.findIndex(d=>d.id===id);
        if (idx>=0) {
          all[idx].status = status; all[idx].motivo = motivo; all[idx].updatedAt = new Date().toISOString();
          if (status === 'Aprovada') {
            all[idx].needsEvidence = false;
            all[idx].riskScore = Math.min(all[idx].riskScore || 0, 2);
            all[idx].riskLevel = 'Baixo';
            all[idx].riskClass = 'risk-low';
          }
          lsSet(LS_KEYS.DONATIONS, all);
          const pend = lsGet(LS_KEYS.PENDING).filter(d=>d.id!==id); lsSet(LS_KEYS.PENDING, pend);
          if (status === 'Aprovada') {
            const rec = lsGet(LS_KEYS.RECENT); rec.unshift(all[idx]); if (rec.length>50) rec.splice(50); lsSet(LS_KEYS.RECENT, rec);
          }
          pushAuditEvents([buildAuditEvent(all[idx], status === 'Aprovada' ? 'Aprovada' : 'Rejeitada', 'Mentor/Admin', { motivo })]);
          const { normalized } = syncDonationCaches();
          return normalized.find(d => d.id === id) || all[idx];
        }
        return null;
      }

      function flagDonationForEvidence(id, actor, reason='') {
        const all = lsGet(LS_KEYS.DONATIONS); const idx = all.findIndex(d=>d.id===id);
        if (idx >= 0) {
          all[idx].needsEvidence = true;
          all[idx].riskScore = Math.max(all[idx].riskScore || 0, 10);
          all[idx].riskLevel = 'Alto';
          all[idx].riskClass = 'risk-high';
          lsSet(LS_KEYS.DONATIONS, all);
          const pend = lsGet(LS_KEYS.PENDING).map(d => d.id === id ? { ...d, needsEvidence: true, riskLevel: 'Alto', riskClass: 'risk-high' } : d);
          lsSet(LS_KEYS.PENDING, pend);
          pushAuditEvents([buildAuditEvent(all[idx], 'Solicitada Evidência', actor || 'Mentor/Admin', { reason })]);
          syncDonationCaches();
          return true;
        }
        return false;
      }

      function appendEvidenceToDonation(id, photos=[], actor='Participante') {
        const newPhotos = Array.from(photos || []);
        if (!newPhotos.length) return null;
        const all = lsGet(LS_KEYS.DONATIONS); const idx = all.findIndex(d=>d.id===id);
        if (idx >= 0) {
          const donation = all[idx];
          const existingPrints = donation.fingerprints || [];
          const incoming = fingerprintsFromPhotos(newPhotos);
          const filtered = newPhotos.filter((src, i) => !existingPrints.includes(incoming[i]));
          const filteredPrints = incoming.filter((hash) => !existingPrints.includes(hash));
          if (!filtered.length) {
            return donation;
          }
          donation.photos = [...(donation.photos || []), ...filtered];
          donation.fingerprints = [...existingPrints, ...filteredPrints];
          donation.updatedAt = new Date().toISOString();
          donation.needsEvidence = false;
          lsSet(LS_KEYS.DONATIONS, all);
          const pend = lsGet(LS_KEYS.PENDING).map(d => d.id === id ? { ...d, photos: donation.photos, fingerprints: donation.fingerprints, needsEvidence: false } : d);
          lsSet(LS_KEYS.PENDING, pend);
          pushAuditEvents([buildAuditEvent(donation, 'Evidência Anexada', actor || 'Participante', { quantidade: filtered.length })]);
          const { normalized } = syncDonationCaches();
          return normalized.find(d => d.id === id) || donation;
        }
        return null;
      }

      // === Student: registro de doações ===
      function StudentDonationsSection({ user }) {
        const [form, setForm] = useState({ description:'', amount:'', category:'alimento', team:'', photos:[], previews:[] });
        const [error, setError] = useState('');
        const [success, setSuccess] = useState('');
        const [mine, setMine] = useState([]);
        const [teams, setTeams] = useState([]);
        const [uploading, setUploading] = useState(false);

        const unitFor = (cat) => (cat==='alimento' ? 'kg' : cat==='fundos' ? 'R$' : 'un');
        const placeholderFor = (cat) => (cat==='alimento' ? 'Valor (kg)' : cat==='fundos' ? 'Valor (R$)' : 'Quantidade (un)');

        const readFilesAsDataUrls = async (fileList) => {
          const files = Array.from(fileList || []).slice(0, 6);
          const readers = files.map(f => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(f);
          }));
          return Promise.all(readers);
        };

        const onPhotosChange = async (e) => {
          const dataUrls = await readFilesAsDataUrls(e.target.files);
          setForm(f => ({ ...f, photos: dataUrls, previews: dataUrls }));
        };

        const loadMine = () => setMine(listUserDonations(user));
        useEffect(()=>{ loadMine(); }, [user?.name]);
        // Carrega equipes existentes da API para ajudar o aluno a selecionar
        useEffect(()=>{
          const BASE_URL = (window.__ENV && window.__ENV.API_URL) || 'http://localhost:3001';
          (async ()=>{
            try {
              const res = await fetch(`${BASE_URL}/api/leaders`);
              const json = await res.json();
              if (res.ok) {
                const uniques = Array.from(new Set((json.data||[]).map(l=>l.team).filter(Boolean)));
                setTeams(uniques);
              }
            } catch {}
          })();
        }, []);

        const submit = (e) => {
          e.preventDefault(); setError(''); setSuccess('');
          if (!form.description || !form.amount || !form.team) { setError('Preencha todos os campos (inclua a Equipe)'); return; }
          if (!form.photos || form.photos.length < 2) { setError('Envie pelo menos duas fotos (item + contexto)'); return; }
          const amount = parseFloat(form.amount);
          if (isNaN(amount) || amount<=0) { setError('Valor inválido'); return; }
          const unit = unitFor(form.category);
          createDonation({ description: form.description, amount, category: form.category, unit, team: form.team, user: { id: user.name, name: user.name, role: user.role }, photos: form.photos });
          setForm({ description:'', amount:'', category: form.category, team: form.team, photos:[], previews:[] });
          setSuccess('Atividade registrada com sucesso!');
          loadMine();
        };

        const addEvidence = async (donationId, files) => {
          if (!files || files.length === 0) return;
          try {
            setUploading(true); setError('');
            const dataUrls = await readFilesAsDataUrls(files);
            const updated = appendEvidenceToDonation(donationId, dataUrls, user?.name || 'Participante');
            if (updated) {
              setSuccess('Evidências adicionais anexadas com sucesso!');
              loadMine();
            }
          } catch (e) {
            setError('Não foi possível anexar as evidências. Tente novamente.');
          } finally {
            setUploading(false);
          }
        };

        return (
          <div className="container" style={{ paddingTop: 16 }}>
            <div className="grid-2">
              <Card title="Registrar Doação">
                <form onSubmit={submit} style={{ display:'grid', gap:12 }} className="anim-fade">
                  <input className="input" placeholder="Descrição" value={form.description} onChange={(e)=>setForm(f=>({...f, description:e.target.value}))} />
                  <select className="input" value={form.category} onChange={(e)=>setForm(f=>({...f, category:e.target.value}))}>
                    <option value="alimento">Doações de alimento (kg)</option>
                    <option value="fundos">Arrecadações de fundos (R$)</option>
                    <option value="brinquedos">Brinquedos (un)</option>
                  </select>
                  <div style={{ display:'grid', gap:8 }}>
                    <select className="input" value={form.team} onChange={(e)=>setForm(f=>({...f, team:e.target.value}))}>
                      <option value="">Selecione a Equipe</option>
                      {teams.map(t=> <option key={t} value={t}>{t}</option>)}
                      <option value="__other">Outra (digitar abaixo)</option>
                    </select>
                    {form.team==='__other' && (
                      <input className="input" placeholder="Nome da Equipe" value={form.__teamText||''} onChange={(e)=>setForm(f=>({ ...f, __teamText: e.target.value, team: '__other' }))} onBlur={()=>{ if(form.__teamText){ setForm(f=>({ ...f, team: f.__teamText })); } }} />
                    )}
                  </div>
                  <input className="input" placeholder={placeholderFor(form.category)} value={form.amount} onChange={(e)=>setForm(f=>({...f, amount:e.target.value}))} />
                  <div style={{ display:'grid', gap:8 }}>
                    <input className="input" type="file" accept="image/*" multiple onChange={onPhotosChange} />
                    <div style={{ color:'#6c757d', fontSize:12 }}>Envie ao menos 2 fotos: item e contexto (máx. 6)</div>
                    {form.previews && form.previews.length > 0 && (
                      <div style={{ display:'flex', gap:8, flexWrap:'wrap' }}>
                        {form.previews.map((src, idx) => (
                          <img key={idx} src={src} alt={`Foto ${idx+1}`} style={{ width:72, height:72, objectFit:'cover', borderRadius:8, border:'1px solid #e9ecef' }} />
                        ))}
                      </div>
                    )}
                  </div>
                  <div style={{ display:'flex', gap:12, alignItems:'center' }}>
                    <button className="btn" type="submit">Cadastrar</button>
                    {uploading && <span className="muted">Enviando evidências…</span>}
                    {error && <span style={{ color:'#dc3545' }}>{error}</span>}
                    {success && <span style={{ color:'#198754' }}>{success}</span>}
                  </div>
                </form>
              </Card>
              <Card title="Minhas Doações">
                <div style={{ overflowX:'auto' }}>
                  <table style={{ width:'100%', borderCollapse:'collapse' }}>
                    <thead>
                      <tr style={{ textAlign:'left', color:'#495057' }}>
                        <th style={{ padding:8 }}>#</th>
                        <th style={{ padding:8 }}>Descrição</th>
                        <th style={{ padding:8 }}>Equipe</th>
                        <th style={{ padding:8 }}>Categoria</th>
                        <th style={{ padding:8 }}>Valor</th>
                        <th style={{ padding:8 }}>Status</th>
                        <th style={{ padding:8 }}>Risco</th>
                        <th style={{ padding:8, textAlign:'right' }}>Ações</th>
                      </tr>
                    </thead>
                    <tbody>
                      {mine.length===0 && <tr><td colSpan="8" style={{ padding:8, color:'#6c757d' }}>Nenhum registro encontrado</td></tr>}
                      {mine.map((d,i)=> (
                        <tr key={d.id} style={{ borderTop:'1px solid #e9ecef' }}>
                          <td style={{ padding:8 }}>{i+1}</td>
                          <td style={{ padding:8 }}>{d.description}</td>
                          <td style={{ padding:8 }}>{d.team || '-'}</td>
                          <td style={{ padding:8 }}>{d.category}</td>
                          <td style={{ padding:8 }}>{d.category==='fundos' ? `R$ ${d.amount.toFixed(2)}` : `${d.amount} ${d.unit||''}`}</td>
                          <td style={{ padding:8 }}>{d.status}</td>
                          <td style={{ padding:8 }}>
                            <span className={`risk-badge ${d.riskClass || 'risk-low'}`} title={`Score ${d.riskScore || 0}`}>
                              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2L2 22h20L12 2z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                              {d.riskLevel || 'Baixo'}
                            </span>
                          </td>
                          <td style={{ padding:8, textAlign:'right' }}>
                            <div style={{ display:'inline-flex', gap:8, alignItems:'center' }}>
                              <button className="btn btn-ghost btn-sm" type="button" onClick={()=>setSuccess(`Registro #${d.id} possui ${d.photos?.length||0} evidência(s).`)}>Ver status</button>
                              {d.needsEvidence && (
                                <label className="btn btn-sm" style={{ cursor:'pointer' }}>
                                  Anexar Evidências
                                  <input
                                    type="file"
                                    accept="image/*"
                                    multiple
                                    onChange={(e)=>{ const files = e.target.files; addEvidence(d.id, files); e.target.value=''; }}
                                    style={{ display:'none' }}
                                  />
                                </label>
                              )}
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </Card>
            </div>
            {/* Resumo: subtotais por status e totais aprovados por categoria */}
            <div className="card" style={{ marginTop:16 }}>
              {(() => {
                const pend = mine.filter(d=>d.status==='Pendente').length;
                const apro = mine.filter(d=>d.status==='Aprovada').length;
                const rej = mine.filter(d=>d.status==='Rejeitada').length;
                const approved = mine.filter(d=>d.status==='Aprovada');
                const food = approved.filter(d=>d.category==='alimento').reduce((s,d)=>s+(d.amount||0),0);
                const funds = approved.filter(d=>d.category==='fundos').reduce((s,d)=>s+(d.amount||0),0);
                const toys = approved.filter(d=>d.category==='brinquedos').reduce((s,d)=>s+(d.amount||0),0);
                return (
                  <div className="anim-fade">
                    <div style={{ fontWeight:700, marginBottom:8, color:'#0f5132' }}>Resumo</div>
                    <div style={{ display:'grid', gridTemplateColumns:'repeat(3, 1fr)', gap:12 }}>
                      <div className="card" style={{ padding:12 }}><div style={{ color:'#0f5132', fontWeight:700 }}>Pendentes</div><div style={{ fontSize:22, fontWeight:800 }}>{pend}</div></div>
                      <div className="card" style={{ padding:12 }}><div style={{ color:'#0f5132', fontWeight:700 }}>Aprovadas</div><div style={{ fontSize:22, fontWeight:800 }}>{apro}</div></div>
                      <div className="card" style={{ padding:12 }}><div style={{ color:'#0f5132', fontWeight:700 }}>Rejeitadas</div><div style={{ fontSize:22, fontWeight:800 }}>{rej}</div></div>
                    </div>
                    <div style={{ marginTop:12, display:'grid', gridTemplateColumns:'repeat(3, 1fr)', gap:12 }}>
                      <div className="card" style={{ padding:12 }}><div style={{ color:'#0f5132', fontWeight:700 }}>Alimentos (kg) aprovados</div><div style={{ fontSize:22, fontWeight:800 }}>{food.toFixed(2)}</div></div>
                      <div className="card" style={{ padding:12 }}><div style={{ color:'#0f5132', fontWeight:700 }}>Fundos (R$) aprovados</div><div style={{ fontSize:22, fontWeight:800 }}>{funds.toFixed(2)}</div></div>
                      <div className="card" style={{ padding:12 }}><div style={{ color:'#0f5132', fontWeight:700 }}>Brinquedos (un) aprovados</div><div style={{ fontSize:22, fontWeight:800 }}>{toys}</div></div>
                    </div>
                    {mine.some(d=>d.needsEvidence) && (
                      <div style={{ marginTop:16, padding:16 }} className="card">
                        <div className="subtitle">Evidências Pendentes</div>
                        <div className="muted" style={{ fontSize:13, marginTop:4 }}>Envie fotos extras para as doações destacadas acima. Isso ajuda a evitar fraudes e acelera a aprovação.</div>
                      </div>
                    )}
                  </div>
                );
              })()}
            </div>
          </div>
        );
      }

      // === Mentor: aprovação de doações pendentes ===
      function MentorApprovalSection() {
        const [pending, setPending] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');
        const [viewerPhotos, setViewerPhotos] = useState(null);
        const [feedback, setFeedback] = useState('');
        const tbodyRef = React.useRef(null);

        const load = () => {
          setLoading(true); setError(''); setFeedback('');
          try { setPending(listPending()); } catch (e) { setError('Erro ao carregar'); }
          finally { setLoading(false); }
        };
        useEffect(()=>{ load(); }, []);

        useEffect(()=>{
          const tbody = tbodyRef.current;
          if (!tbody) return;
          const onClick = (e) => {
            const tr = e.target.closest('tr[data-id]');
            if (!tr) return;
            const id = tr.getAttribute('data-id');
            const isSelected = tr.classList.contains('linha-selecionada');
            Array.from(tbody.querySelectorAll('tr[data-id]')).forEach(row => row.classList.remove('linha-selecionada'));
            if (isSelected) {
              tr.classList.remove('linha-selecionada');
            } else {
              tr.classList.add('linha-selecionada');
            }
          };
          tbody.addEventListener('click', onClick);
          return () => tbody.removeEventListener('click', onClick);
        }, [tbodyRef]);

        const doApprove = (id) => { updateDonationStatus(id, 'Aprovada'); setFeedback('Doação aprovada com sucesso.'); load(); };
        const doReject = (id) => {
          const motivo = prompt('Motivo da rejeição (opcional):') || null;
          updateDonationStatus(id, 'Rejeitada', motivo); setFeedback('Doação rejeitada. Histórico atualizado.'); load();
        };
        const requestEvidence = (id) => {
          const reason = prompt('Descreva o que precisa ser comprovado:') || 'Verificação adicional solicitada';
          flagDonationForEvidence(id, 'Mentor/Admin', reason);
          setFeedback('Evidências adicionais solicitadas. O participante foi notificado.');
          load();
        };
        const openPhotos = (donation) => {
          const photos = donation?.photos || [];
          if (photos.length > 0) setViewerPhotos(photos);
        };

        return (
          <div className="container" style={{ paddingTop: 16 }}>
            <Card title="Aprovação de Doações" right={<button className="btn" onClick={load}>Atualizar</button>}>
              {loading && <span>Carregando…</span>}
              {error && <div style={{ color:'#dc3545' }}>{error}</div>}
              {feedback && <div style={{ color:'#4df2c2', marginBottom:8 }}>{feedback}</div>}
              <div style={{ overflowX:'auto', marginTop:0 }}>
                <table style={{ width:'100%', borderCollapse:'collapse' }}>
                  <thead>
                    <tr style={{ textAlign:'left', color:'#495057' }}>
                      <th style={{ padding:8 }}>#</th>
                      <th style={{ padding:8 }}>Descrição</th>
                      <th style={{ padding:8 }}>Equipe</th>
                      <th style={{ padding:8 }}>Categoria</th>
                      <th style={{ padding:8 }}>Valor</th>
                      <th style={{ padding:8 }}>Aluno</th>
                      <th style={{ padding:8 }}>Risco</th>
                      <th style={{ padding:8 }}>Evidências</th>
                      <th style={{ padding:8, textAlign:'right' }}>Ações</th>
                    </tr>
                  </thead>
                  <tbody ref={tbodyRef}>
                    {!loading && pending.length===0 && (
                      <tr><td colSpan="9" style={{ padding:8, color:'#6c757d' }}>Nenhum registro encontrado</td></tr>
                    )}
                    {pending.map((p, i) => (
                      <tr key={p.id} data-id={p.id} style={{ borderTop:'1px solid #e9ecef' }}>
                        <td style={{ padding:8 }}>{i+1}</td>
                        <td style={{ padding:8 }}>{p.description}</td>
                        <td style={{ padding:8 }}>{p.team || '-'}</td>
                        <td style={{ padding:8 }}>{p.category}</td>
                        <td style={{ padding:8 }}>{p.category==='fundos' ? `R$ ${p.amount.toFixed(2)}` : `${p.amount} ${p.unit||''}`}</td>
                        <td style={{ padding:8 }}>{p.user?.name || '-'}</td>
                        <td style={{ padding:8 }}>
                          <span className={`risk-badge ${p.riskClass || 'risk-low'}`} title={`Score ${p.riskScore || 0}`}>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2L2 22h20L12 2z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                            {p.riskLevel || 'Baixo'}
                          </span>
                        </td>
                        <td style={{ padding:8 }}>
                          <span className="chip">{p.photos?.length || 0} foto(s)</span>
                          {p.needsEvidence && <span className="badge" style={{ marginLeft:8 }}>Evidência pendente</span>}
                        </td>
                        <td style={{ padding:8 }}>
                          <div style={{ display:'inline-flex', gap:8, alignItems:'center' }}>
                            {p.photos && p.photos.length > 0 && (
                              <button
                                className="btn btn-ghost btn-sm"
                                onClick={()=>openPhotos(p)}
                              >
                                Visualizar
                              </button>
                            )}
                            {p.needsEvidence && (
                              <button className="btn btn-ghost btn-sm" onClick={()=>requestEvidence(p.id)}>Reforçar pedido</button>
                            )}
                            {!p.needsEvidence && (
                              <button className="btn btn-ghost btn-sm" onClick={()=>requestEvidence(p.id)}>Solicitar evidência</button>
                            )}
                            <button className="btn btn-sm" onClick={()=>doApprove(p.id)}>Aprovar</button>
                            <button className="btn btn-danger btn-sm" onClick={()=>doReject(p.id)}>Rejeitar</button>
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </Card>
            {viewerPhotos && (
              <div style={{ position:'fixed', inset:0, background:'rgba(0,0,0,0.5)', display:'flex', alignItems:'center', justifyContent:'center', padding:16, zIndex:2000 }} onClick={()=>setViewerPhotos(null)}>
                <div className="card anim-scale" style={{ maxWidth:900, width:'100%', maxHeight:'90vh', overflow:'auto', padding:16 }} onClick={(e)=>e.stopPropagation()}>
                  <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:8 }}>
                    <div style={{ fontWeight:700, color:'#0f5132' }}>Fotos do Registro</div>
                    <button className="btn" onClick={()=>setViewerPhotos(null)}>Fechar</button>
                  </div>
                  <div style={{ display:'flex', gap:12, flexWrap:'wrap' }}>
                    {viewerPhotos.map((src, idx) => (
                      <img key={idx} src={src} alt={`Foto ${idx+1}`} style={{ width:160, height:160, objectFit:'cover', borderRadius:10, border:'1px solid #e9ecef' }} />
                    ))}
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      // === Admin Dashboard (KPIs + Charts + Ranking) ===
      function AnimatedNumber({ value, duration = 800, format }) {
        const [display, setDisplay] = useState(0);
        useEffect(() => {
          if (typeof value !== 'number') { setDisplay(0); return; }
          let raf; const start = performance.now();
          const from = 0; const to = value;
          const easeOut = (t) => 1 - Math.pow(1 - t, 3);
          const step = (now) => {
            const p = Math.min(1, (now - start) / duration);
            const eased = easeOut(p);
            setDisplay(from + (to - from) * eased);
            if (p < 1) raf = requestAnimationFrame(step);
          };
          raf = requestAnimationFrame(step);
          return () => cancelAnimationFrame(raf);
        }, [value, duration]);
        const text = format ? format(display) : Math.round(display).toString();
        return <span>{text}</span>;
      }

      function useRevealOnScroll() {
        useEffect(() => {
          const els = Array.from(document.querySelectorAll('.reveal'));
          if (!('IntersectionObserver' in window)) {
            els.forEach(el => el.classList.add('in-view'));
            return;
          }
          const io = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) entry.target.classList.add('in-view');
            });
          }, { rootMargin: '0px 0px -10% 0px', threshold: 0.1 });
          els.forEach(el => io.observe(el));
          return () => io.disconnect();
        }, []);
      }

      function AdminDashboard() {
        useRevealOnScroll();
        const [leaders, setLeaders] = useState([]);
        const [donations, setDonations] = useState([]);
        const [periodDays, setPeriodDays] = useState(30); // 7 | 30 | 90 | 0 (todos)
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState("");
        const BASE_URL = (window.__ENV && window.__ENV.API_URL) || 'http://localhost:3001';

        useEffect(() => {
          const reload = async () => {
            setLoading(true); setError("");
            try {
              const res = await fetch(`${BASE_URL}/api/leaders`);
              const json = await res.json();
              if (!res.ok) throw new Error(json?.message || `Erro HTTP ${res.status}`);
              setLeaders(json.data || []);
              setDonations(listAllDonations());
            } catch (e) { setError(e.message || 'Erro ao carregar'); }
            finally { setLoading(false); }
          };

          reload();

          const onStorage = (e) => {
            if (e.key === 'gl_donations' || e.key === 'gl_donations_pending' || e.key === 'gl_donations_recent') {
              setDonations(listAllDonations());
            }
          };
          const onFocus = () => { reload(); };
          window.addEventListener('storage', onStorage);
          window.addEventListener('focus', onFocus);
          return () => {
            window.removeEventListener('storage', onStorage);
            window.removeEventListener('focus', onFocus);
          };
        }, []);

        // Agrupamentos por equipe e por role
        // Ranking: baseado em doações APROVADAS por equipe (valores por categoria)
        const approved = donations.filter(d => d.status === 'Aprovada');
        // Janela de período
        const nowTs = Date.now();
        const fromTs = periodDays && periodDays > 0 ? nowTs - periodDays*24*3600*1000 : 0;
        const approvedWindow = approved.filter(d => {
          const ts = new Date(d.updatedAt || d.updated_at || d.createdAt || d.created_at || 0).getTime();
          return fromTs === 0 || ts >= fromTs;
        });
        const donationsByTeam = approvedWindow.reduce((acc, d) => {
          const team = d.team || '—';
          acc[team] = acc[team] || { food:0, funds:0, toys:0 };
          if (d.category==='alimento') acc[team].food += (d.amount||0);
          else if (d.category==='fundos') acc[team].funds += (d.amount||0);
          else if (d.category==='brinquedos') acc[team].toys += (d.amount||0);
          return acc;
        }, {});
        // ainda computamos byRole para KPIs de leaders
        const byTeam = Object.fromEntries(Object.entries(donationsByTeam).map(([team, v]) => [team, (v.food||0)+(v.funds||0)+(v.toys||0)]));
        const byRole = leaders.reduce((acc, l) => { const k = l.role || '—'; acc[k] = (acc[k] || 0) + 1; return acc; }, {});
        const teamsData = Object.entries(byTeam).map(([name, total]) => ({ name, total }));

        // KPIs
        const totalLeaders = leaders.length;
        const totalAlunos = byRole['aluno'] || byRole['Aluno'] || 0;
        const totalMentores = byRole['mentor'] || byRole['Mentor'] || 0;

        // KPIs de Doações por categoria (apenas Aprovadas)
        const dFood = approvedWindow.filter(d=>d.category==='alimento').reduce((s,d)=>s+(d.amount||0),0);
        const dFunds = approvedWindow.filter(d=>d.category==='fundos').reduce((s,d)=>s+(d.amount||0),0);
        const dToys = approvedWindow.filter(d=>d.category==='brinquedos').reduce((s,d)=>s+(d.amount||0),0);
        const byCategory = [
          { name: 'Alimentos (kg)', total: dFood },
          { name: 'Fundos (R$)', total: dFunds },
          { name: 'Brinquedos (un)', total: dToys }
        ];
        // Resumo por status
        const cPending = donations.filter(d=>d.status==='Pendente').length;
        const cApproved = approved.length;
        const cRejected = donations.filter(d=>d.status==='Rejeitada').length;

        // KPI avançados: taxa de aprovação, tempo médio de aprovação, pendências antigas
        const approvalRate = (cApproved + cRejected) > 0 ? (cApproved / (cApproved + cRejected)) : 0;
        const avgApprovalMs = (() => {
          const times = approved
            .map(d => {
              const created = new Date(d.createdAt || d.created_at || Date.now());
              const updated = new Date(d.updatedAt || d.updated_at || d.createdAt || Date.now());
              return Math.max(0, updated - created);
            })
            .filter(v => Number.isFinite(v) && v>0);
          if (!times.length) return 0;
          return times.reduce((s,v)=>s+v,0) / times.length;
        })();
        const avgApprovalHours = avgApprovalMs / (1000*60*60);
        const agingPend = donations
          .filter(d => d.status==='Pendente')
          .map(d => ({ d, ageDays: (Date.now() - new Date(d.createdAt || d.created_at || Date.now()))/(1000*60*60*24) }))
          .filter(x => x.ageDays >= 3)
          .length;

        // Trend: aprovadas por dia (período selecionado; mínimo 14 dias), usando updatedAt (ou createdAt)
        function startOfDay(ts){ const d = new Date(ts); d.setHours(0,0,0,0); return d.getTime(); }
        const today = startOfDay(Date.now());
        const span = Math.max(14, periodDays || 14);
        const days = Array.from({length:span}).map((_,i)=> today - (span-1-i)*24*3600*1000);
        const approvalsByDay = days.map(day => {
          const next = day + 24*3600*1000;
          const total = approvedWindow.filter(d => {
            const stamp = new Date(d.updatedAt || d.updated_at || d.createdAt || d.created_at || Date.now()).getTime();
            return stamp >= day && stamp < next;
          }).length;
          return { day, total };
        });
        const maxTrend = Math.max(1, ...approvalsByDay.map(p=>p.total));

        // Risco agregado
        const riskyDonations = donations.filter(d => (d.riskLevel === 'Alto') && d.status === 'Pendente');
        const mediumRisk = donations.filter(d => (d.riskLevel === 'Médio') && d.status === 'Pendente');
        const evidenceWaiting = donations.filter(d => d.needsEvidence).length;
        const auditEvents = listAuditTrail(8);

        // Crescimento 7d por equipe
        const sevenAgo = Date.now() - 7*24*3600*1000;
        const approved7 = approved.filter(d => new Date(d.updatedAt || d.updated_at || d.createdAt || 0).getTime() >= sevenAgo);
        const totalsNow = donationsByTeam;
        const totals7 = approved7.reduce((acc, d) => {
          const team = d.team || '—';
          acc[team] = acc[team] || { food:0, funds:0, toys:0 };
          if (d.category==='alimento') acc[team].food += (d.amount||0);
          else if (d.category==='fundos') acc[team].funds += (d.amount||0);
          else if (d.category==='brinquedos') acc[team].toys += (d.amount||0);
          return acc;
        }, {});
        function growthFor(team){
          const now = totalsNow[team] || {food:0,funds:0,toys:0};
          const last = totals7[team] || {food:0,funds:0,toys:0};
          const nowSum = (now.food||0)+(now.funds||0)+(now.toys||0);
          const lastSum = (last.food||0)+(last.funds||0)+(last.toys||0);
          return lastSum; // crescimento absoluto na última semana
        }

        // Atividade recente (últimos 10 eventos)
        const recent = [...donations]
          .filter(d => d.updatedAt || d.createdAt)
          .sort((a,b)=> new Date(b.updatedAt || b.createdAt) - new Date(a.updatedAt || a.createdAt))
          .slice(0,10);

        // Cores para gráficos
        const COLORS = ['#006400', '#0E7A0D', '#1E9E1B', '#2ECF25', '#65DB6B', '#A0E7A5'];

        // Pie chart: calcula arcos
        function PieChartSVG({ data, size=260, inner=0 }) {
          const radius = size/2; const cx = radius; const cy = radius; const total = data.reduce((s, d)=>s+d.total,0) || 1;
          let angleStart = -Math.PI/2; // começa no topo
          const paths = [];
          data.forEach((d, i) => {
            const angle = (d.total/total) * Math.PI * 2;
            const angleEnd = angleStart + angle;
            const x1 = cx + radius * Math.cos(angleStart);
            const y1 = cy + radius * Math.sin(angleStart);
            const x2 = cx + radius * Math.cos(angleEnd);
            const y2 = cy + radius * Math.sin(angleEnd);
            const large = angle > Math.PI ? 1 : 0;
            const dPath = `M ${cx} ${cy} L ${x1} ${y1} A ${radius} ${radius} 0 ${large} 1 ${x2} ${y2} Z`;
            paths.push(<path key={i} d={dPath} fill={COLORS[i % COLORS.length]} opacity="0.95"></path>);
            angleStart = angleEnd;
          });
          return (
            <svg width={size} height={size} viewBox={`0 0 ${size} ${size}`}>{paths}</svg>
          );
        }

        // Bar chart simples
        function BarChart({ data, height=260 }) {
          const max = Math.max(...data.map(d=>d.total), 1);
          return (
            <div style={{ display:'grid', gridTemplateRows: `${height}px auto`, gap:8 }}>
              <div style={{ display:'grid', gridAutoFlow:'column', alignItems:'end', gap:12, height }}>
                {data.map((d, i) => (
                  <div
                    key={d.name}
                    className="anim-fade reveal"
                    style={{
                      background:'#198754',
                      width:24,
                      height: Math.max(6, (d.total/max)*height),
                      borderRadius:6,
                      transition: 'height .6s ease, transform .2s ease',
                    }}
                    title={`${d.name}: ${d.total}`}
                  />
                ))}
              </div>
              <div style={{ display:'grid', gridAutoFlow:'column', gap:12, fontSize:12, color:'#495057' }}>
                {data.map(d => <div key={d.name} style={{ writingMode:'vertical-rl', transform:'rotate(180deg)', textAlign:'center' }}>{d.name}</div>)}
              </div>
            </div>
          );
        }

        // Ranking controls: estado no componente
        const [rankBy, setRankBy] = useState('alimento'); // 'alimento' | 'fundos' | 'brinquedos'
        function RankingControls(){
          return (
            <div style={{ display:'flex', gap:8, alignItems:'center' }}>
              <span style={{ color:'#495057', fontSize:14 }}>Ordenar por</span>
              <select className="input" style={{ padding:'6px 10px', width:160 }} value={rankBy} onChange={(e)=>setRankBy(e.target.value)}>
                <option value="alimento">Alimentos (kg)</option>
                <option value="fundos">Fundos (R$)</option>
                <option value="brinquedos">Brinquedos (un)</option>
              </select>
            </div>
          );
        }
        function getRankingRows(){
          const rows = Object.entries(donationsByTeam).map(([team, v]) => ({ team, food: v.food||0, funds: v.funds||0, toys: v.toys||0 }));
          const key = rankBy==='alimento' ? 'food' : rankBy==='fundos' ? 'funds' : 'toys';
          return rows.sort((a,b)=> (b[key] - a[key]));
        }

        return (
          <div className="container" style={{ paddingTop: 0 }}>
            {/* Header + Filtros + Atualizar */}
            <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:8 }}>
              <div style={{ fontWeight:800, color:'#0f5132' }}>Painel do Administrador</div>
              <div style={{ display:'flex', gap:8, alignItems:'center' }}>
                <select className="input" style={{ width:160, padding:'6px 10px' }} value={periodDays} onChange={(e)=>setPeriodDays(parseInt(e.target.value,10))}>
                  <option value={7}>Últimos 7 dias</option>
                  <option value={30}>Últimos 30 dias</option>
                  <option value={90}>Últimos 90 dias</option>
                  <option value={0}>Todos</option>
                </select>
                <button className="btn" onClick={()=>{
                  // Recarrega leaders e donations
                  (async () => {
                    try {
                      const res = await fetch(`${BASE_URL}/api/leaders`);
                      const json = await res.json();
                      if (res.ok) setLeaders(json.data || []);
                    } catch {}
                    setDonations(listAllDonations());
                  })();
                }}>Atualizar</button>
                <button className="btn btn-ghost" onClick={()=>{
                  const rows = getRankingRows().map((row, i) => ({
                    rank: i+1,
                    team: row.team,
                    alimentos_kg: row.food.toFixed(2),
                    fundos_rs: row.funds.toFixed(2),
                    brinquedos_un: row.toys,
                    crescimento_7d: (growthFor(row.team)).toFixed(2)
                  }));
                  const headers = Object.keys(rows[0] || { rank:'', team:'', alimentos_kg:'', fundos_rs:'', brinquedos_un:'', crescimento_7d:'' });
                  const csv = [headers.join(','), ...rows.map(r => headers.map(h => `${String(r[h]).replace(/"/g,'""')}`).join(','))].join('\n');
                  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url; a.download = `ranking_equipes_${periodDays||'todos'}d.csv`;
                  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                }}>Exportar CSV</button>
              </div>
            </div>

            {/* KPIs de Leaders + avançados */}
            <div className="grid-auto anim-fade">
              <div className="card reveal anim-pop col-3"><div className="subtitle">Total de Leaders</div><div style={{ fontSize:28, fontWeight:800 }}><AnimatedNumber value={totalLeaders} /></div><div className="muted" style={{ fontSize:12 }}>Equipe cadastrada</div></div>
              <div className="card reveal anim-pop col-3"><div className="subtitle">Alunos</div><div style={{ fontSize:28, fontWeight:800 }}><AnimatedNumber value={totalAlunos} /></div><div className="muted" style={{ fontSize:12 }}>Contas de aluno</div></div>
              <div className="card reveal anim-pop col-3"><div className="subtitle">Mentores</div><div style={{ fontSize:28, fontWeight:800 }}><AnimatedNumber value={totalMentores} /></div><div className="muted" style={{ fontSize:12 }}>Contas de mentor</div></div>
              <div className="card reveal anim-pop col-3"><div className="subtitle">Taxa de Aprovação</div><div style={{ fontSize:28, fontWeight:800 }}><AnimatedNumber value={approvalRate*100} format={(v)=>`${v.toFixed(0)}%`} /></div><div className="muted" style={{ fontSize:12 }}>Aprovadas / (Aprovadas + Rejeitadas)</div></div>
            </div>

            {/* KPIs de Doações + operacionais */}
            <div className="grid-auto anim-fade" style={{ marginTop:16 }}>
              <div className="card reveal anim-pop col-3"><div className="subtitle">Alimentos (kg)</div><div style={{ fontSize:28, fontWeight:800 }}><AnimatedNumber value={dFood} duration={900} format={(v)=>v.toFixed(2)} /></div></div>
              <div className="card reveal anim-pop col-3"><div className="subtitle">Fundos (R$)</div><div style={{ fontSize:28, fontWeight:800 }}><AnimatedNumber value={dFunds} duration={900} format={(v)=>v.toFixed(2)} /></div></div>
              <div className="card reveal anim-pop col-3"><div className="subtitle">Brinquedos (un)</div><div style={{ fontSize:28, fontWeight:800 }}><AnimatedNumber value={dToys} /></div></div>
              <div className="card reveal anim-pop col-3"><div className="subtitle">Tempo Médio de Aprovação</div><div style={{ fontSize:28, fontWeight:800 }}><AnimatedNumber value={avgApprovalHours} format={(v)=>`${v.toFixed(1)} h`} /></div><div className="muted" style={{ fontSize:12 }}>Intervalo entre registro e aprovação</div></div>
            </div>

            {/* Resumo de Status */}
            <div className="grid-auto anim-fade" style={{ marginTop:16 }}>
              <div className="card reveal anim-pop col-4"><div className="subtitle">Pendentes</div><div style={{ display:'flex', alignItems:'baseline', gap:12 }}><div style={{ fontSize:28, fontWeight:800 }}><AnimatedNumber value={cPending} /></div>{agingPend>0 && <span className="badge">{agingPend} 3d+</span>}</div></div>
              <div className="card reveal anim-pop col-4"><div className="subtitle">Aprovadas</div><div style={{ fontSize:28, fontWeight:800 }}><AnimatedNumber value={cApproved} /></div></div>
              <div className="card reveal anim-pop col-4"><div className="subtitle">Rejeitadas</div><div style={{ fontSize:28, fontWeight:800 }}><AnimatedNumber value={cRejected} /></div></div>
            </div>

            {/* Cards de Risco/Auditoria */}
            <div className="grid-auto" style={{ marginTop:16 }}>
              <div className="card anim-fade reveal col-4">
                <div className="subtitle">Risco Alto Pendentes</div>
                <div style={{ fontSize:32, fontWeight:800, display:'flex', alignItems:'center', gap:12 }}>
                  <AnimatedNumber value={riskyDonations.length} />
                  {riskyDonations.length>0 && <span className="badge">Atenção imediata</span>}
                </div>
                <div className="muted" style={{ fontSize:13 }}>Doações aguardando aprovação com score alto</div>
              </div>
              <div className="card anim-fade reveal col-4">
                <div className="subtitle">Risco Médio Pendentes</div>
                <div style={{ fontSize:32, fontWeight:800 }}><AnimatedNumber value={mediumRisk.length} /></div>
                <div className="muted" style={{ fontSize:13 }}>Monitore para evitar acúmulo de análise</div>
              </div>
              <div className="card anim-fade reveal col-4">
                <div className="subtitle">Evidências Solicitadas</div>
                <div style={{ fontSize:32, fontWeight:800 }}><AnimatedNumber value={evidenceWaiting} /></div>
                <div className="muted" style={{ fontSize:13 }}>Participantes precisam anexar fotos extras</div>
              </div>
            </div>

            <div className="card anim-fade reveal" style={{ marginTop:16 }}>
              <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:8 }}>
                <div className="subtitle">Linha do tempo de Auditoria</div>
                <button className="btn btn-ghost btn-sm" onClick={()=>{
                  const csvEvents = listAuditTrail(100).map(ev => ({
                    id: ev.id,
                    doacao: ev.donationId,
                    acao: ev.action,
                    ator: ev.actor,
                    horario: ev.timestamp,
                    detalhes: JSON.stringify(ev.extra || {})
                  }));
                  const headers = Object.keys(csvEvents[0] || { id:'', doacao:'', acao:'', ator:'', horario:'', detalhes:'' });
                  const csv = [headers.join(','), ...csvEvents.map(r => headers.map(h => `${String(r[h]).replace(/"/g,'""')}`).join(','))].join('\n');
                  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement('a');
                  a.href = url; a.download = `auditoria_${Date.now()}.csv`;
                  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
                }}>Exportar auditoria</button>
              </div>
              {auditEvents.length === 0 ? (
                <div className="muted">Nenhum evento registrado ainda.</div>
              ) : (
                <div className="audit-timeline">
                  {auditEvents.map(ev => (
                    <div key={ev.id} className="audit-timeline-item">
                      <div className="audit-icon">⏵</div>
                      <div>
                        <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center' }}>
                          <strong>{ev.action}</strong>
                          <span>{new Date(ev.timestamp).toLocaleString()}</span>
                        </div>
                        <div className="muted" style={{ fontSize:12 }}>Doação #{ev.donationId} • {ev.actor}</div>
                        {ev.extra && Object.keys(ev.extra).length > 0 && (
                          <div style={{ marginTop:4, fontSize:12, color:'#f0fff8' }}>{Object.entries(ev.extra).map(([k,v])=>`${k}: ${typeof v==='object'?JSON.stringify(v):v}`).join(' • ')}</div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Charts */}
            <div className="grid-auto" style={{ marginTop:16 }}>
              <div className="card anim-scale reveal col-6">
                <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center' }}>
                  <div className="subtitle">Doações por Categoria</div>
                  <span className="chip">Somente aprovadas</span>
                </div>
                {byCategory.some(c=>c.total>0) ? <PieChartSVG data={byCategory} /> : <span style={{ color:'#6c757d' }}>Nenhum dado</span>}
              </div>
              <div className="card anim-scale reveal col-6">
                <div className="subtitle" style={{ marginBottom:8 }}>Totais por Categoria</div>
                {byCategory.some(c=>c.total>0) ? <BarChart data={byCategory} /> : <span style={{ color:'#6c757d' }}>Nenhum dado</span>}
              </div>
            </div>

            {/* Trend: aprovações por dia (14d) */}
            <div className="card anim-fade reveal" style={{ marginTop:16 }}>
              <div className="subtitle" style={{ marginBottom:8 }}>Aprovações nos últimos 14 dias</div>
              {(() => {
                const width = 760; const height = 220; const padding = 24; const maxY = maxTrend;
                const points = approvalsByDay.map((p,i)=>{
                  const x = padding + (i/(approvalsByDay.length-1))*(width - padding*2);
                  const y = padding + (1 - (p.total / maxY))*(height - padding*2);
                  return { x, y, v: p.total };
                });
                const path = points.map((pt,i)=> `${i===0?'M':'L'} ${pt.x} ${pt.y}`).join(' ');
                return (
                  <svg width={width} height={height} viewBox={`0 0 ${width} ${height}`} style={{ width:'100%', height:'auto' }}>
                    <defs>
                      <linearGradient id="g" x1="0" x2="0" y1="0" y2="1">
                        <stop offset="0%" stopColor="#198754" stopOpacity="0.28" />
                        <stop offset="100%" stopColor="#198754" stopOpacity="0.02" />
                      </linearGradient>
                    </defs>
                    <path d={path} fill="none" stroke="#198754" strokeWidth="2" />
                    <path d={`${path} L ${width-padding} ${height-padding} L ${padding} ${height-padding} Z`} fill="url(#g)" opacity="0.8" />
                    {points.map((pt,i)=> (
                      <g key={i}>
                        <circle cx={pt.x} cy={pt.y} r="3" fill="#0f5132" />
                      </g>
                    ))}
                  </svg>
                );
              })()}
            </div>

            {/* Ranking por Doações Aprovadas (ordenar por categoria) */}
            <div className="card anim-fade reveal" style={{ marginTop:16 }}>
              <div style={{ display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:8 }}>
                <div style={{ fontWeight:700, color:'#0f5132' }}>Ranking de Equipes (Doações Aprovadas)</div>
                <RankingControls />
              </div>
              <div style={{ overflowX:'auto' }}>
                <table style={{ width:'100%', borderCollapse:'collapse' }}>
                  <thead>
                    <tr style={{ textAlign:'left', color:'#495057' }}>
                      <th style={{ padding:8 }}>#</th>
                      <th style={{ padding:8 }}>Equipe</th>
                      <th style={{ padding:8 }}>Alimentos (kg)</th>
                      <th style={{ padding:8 }}>Fundos (R$)</th>
                      <th style={{ padding:8 }}>Brinquedos (un)</th>
                      <th style={{ padding:8 }}>Crescimento 7d</th>
                    </tr>
                  </thead>
                  <tbody>
                    {getRankingRows().map((row, i) => (
                      <tr key={row.team} style={{ borderTop:'1px solid #e9ecef' }}>
                        <td style={{ padding:8 }}>{i+1}</td>
                        <td style={{ padding:8 }}>{row.team}</td>
                        <td style={{ padding:8 }}>{row.food.toFixed(2)}</td>
                        <td style={{ padding:8 }}>{row.funds.toFixed(2)}</td>
                        <td style={{ padding:8 }}>{row.toys}</td>
                        <td style={{ padding:8 }}>
                          {(() => { const g = growthFor(row.team); const sign = g>0?'+':''; return <span className="badge" title="Aprovadas na última semana">{sign}{(g).toFixed(2)}</span>; })()}
                        </td>
                      </tr>
                    ))}
                    {!teamsData.length && (
                      <tr><td colSpan="5" style={{ padding:8, color:'#6c757d' }}>Nenhum registro encontrado</td></tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Atividade recente */}
            <div className="card anim-fade reveal" style={{ marginTop:16 }}>
              <div className="subtitle" style={{ marginBottom:8 }}>Atividade recente</div>
              <div className="divider"></div>
              {recent.length === 0 ? (
                <div className="muted">Sem eventos recentes</div>
              ) : (
                <div style={{ display:'grid', gap:8 }}>
                  {recent.map((r, idx) => (
                    <div key={idx} style={{ display:'flex', justifyContent:'space-between', alignItems:'center' }}>
                      <div style={{ display:'flex', gap:8, alignItems:'center' }}>
                        <span className="chip">{r.status}</span>
                        <span>{r.description}</span>
                        <span className="muted" style={{ fontSize:12 }}>{r.team || '—'}</span>
                      </div>
                      <span className="muted" style={{ fontSize:12 }}>{new Date(r.updatedAt || r.createdAt).toLocaleString()}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
            {error && <div style={{ color:'#dc3545', marginTop:8 }}>{error}</div>}
          </div>
        );
      }

      function Card({ children, title, right }) {
        return (
          <div className="card">
            {title && (
              <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:8, color:'#0f5132', fontWeight:700}}>
                <div>{title}</div>
                {right}
              </div>
            )}
            {children}
          </div>
        );
      }

      function LeadersSection() {
        const [leaders, setLeaders] = useState([]);
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState('');
        const [form, setForm] = useState({ name:'', role:'', email:'', team:'' });
        const BASE_URL = (window.__ENV && window.__ENV.API_URL) || 'http://localhost:3001';

        const load = async () => {
          setLoading(true); setError('');
          try {
            const res = await fetch(`${BASE_URL}/api/leaders`);
            const json = await res.json();
            if (!res.ok) throw new Error(json?.message || `Erro HTTP ${res.status}`);
            setLeaders(json.data || []);
          } catch (e) { setError(e.message || 'Erro ao carregar'); }
          finally { setLoading(false); }
        };

        useEffect(() => { load(); }, []);

        const onChange = (e) => setForm(f => ({...f, [e.target.name]: e.target.value}));
        const onSubmit = async (e) => {
          e.preventDefault(); setError('');
          if (!form.name || !form.role || !form.email) { setError('Preencha nome, cargo e email'); return; }
          try {
            const res = await fetch(`${BASE_URL}/api/leaders`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(form) });
            const json = await res.json();
            if (!res.ok) throw new Error(json?.message || 'Erro ao cadastrar');
            setForm({ name:'', role:'', email:'', team:'' });
            await load();
          } catch (e) { setError(e.message || 'Erro ao cadastrar'); }
        };
        const onDelete = async (id) => {
          if (!confirm('Deseja remover este leader?')) return;
          setError('');
          try {
            const res = await fetch(`${BASE_URL}/api/leaders/${id}`, { method:'DELETE' });
            const json = await res.json().catch(()=>({}));
            if (!res.ok) throw new Error(json?.message || 'Erro ao excluir');
            await load();
          } catch (e) { setError(e.message || 'Erro ao excluir'); }
        };

        return (
          <Card title="Cadastro de Leaders" right={<button className="btn" onClick={load}>Atualizar</button>}>
            <form onSubmit={onSubmit} style={{ display:'grid', gridTemplateColumns:'repeat(4, 1fr)', gap:12 }}>
              <input className="input" name="name" placeholder="Nome" value={form.name} onChange={onChange} />
              <input className="input" name="role" placeholder="Cargo" value={form.role} onChange={onChange} />
              <input className="input" name="email" placeholder="Email" value={form.email} onChange={onChange} />
              <input className="input" name="team" placeholder="Equipe (opcional)" value={form.team} onChange={onChange} />
              <div style={{ gridColumn:'1/-1', display:'flex', gap:12, alignItems:'center' }}>
                <button className="btn" type="submit">Cadastrar</button>
                {loading && <span>Carregando…</span>}
                {error && <span style={{ color:'#dc3545' }}>{error}</span>}
              </div>
            </form>

            <div style={{ overflowX:'auto', marginTop:8 }}>
              <table>
                <thead>
                  <tr><th>#</th><th>Nome</th><th>Cargo</th><th>Email</th><th>Equipe</th><th></th></tr>
                </thead>
                <tbody>
                  {!loading && leaders.length === 0 && (
                    <tr><td colSpan="6" style={{ color:'#6c757d' }}>Nenhum registro encontrado</td></tr>
                  )}
                  {leaders.map((l,i) => (
                    <tr key={l.id}>
                      <td>{i+1}</td>
                      <td>{l.name}</td>
                      <td>{l.role}</td>
                      <td>{l.email}</td>
                      <td>{l.team || '-'}</td>
                      <td><button className="btn btn-danger" onClick={()=>onDelete(l.id)}>Excluir</button></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </Card>
        );
      }

      function LoginForm({ onLogin }) {
        const [mode, setMode] = React.useState('login'); // 'login' | 'register'
        const [name, setName] = React.useState("");
        const [email, setEmail] = React.useState("");
        const [password, setPassword] = React.useState("");
        const [confirm, setConfirm] = React.useState("");
        const [role, setRole] = React.useState("aluno");
        const [error, setError] = React.useState("");
        const [showPwd, setShowPwd] = React.useState(false);
        const [remember, setRemember] = React.useState(true);

        const submit = (e) => {
          e.preventDefault();
          setError("");
          if (mode === 'login') {
            if (!email || !password) { setError('Informe email e senha'); return; }
            const finalName = email?.split('@')[0] || 'Usuário';
            onLogin({ name: finalName, role });
          } else {
            if (!name || !email || !password || !confirm) { setError('Preencha todos os campos'); return; }
            if (password !== confirm) { setError('As senhas não conferem'); return; }
            onLogin({ name, role });
          }
        };

        const Title = () => (
          <div className="login-title anim-fade">
            Gestão de Doações<br />Lideranças Empáticas
          </div>
        );

        return (
          <div className="login-wrapper">
            <div className="login-card anim-scale">
              <div className="login-header anim-fade">
                <div className="login-logos">
                  <img className="auth-logo-lg" src="./public/logos/logo1.png" alt="Lideranças Empáticas" />
                  <img className="auth-logo-sm" src="./public/logos/logo2.png" alt="FECAP" />
                </div>
                <Title />
                <div className="login-subtitle">Gestão inteligente de doações em tempo real</div>
              </div>
              <form onSubmit={submit} className="login-form anim-fade">
                {mode === 'register' && (
                  <>
                    <input className="input" placeholder="Nome completo" value={name} onChange={(e)=>setName(e.target.value)} />
                    <input className="input" placeholder="Email" value={email} onChange={(e)=>setEmail(e.target.value)} />
                    <select className="input" value={role} onChange={(e)=>setRole(e.target.value)}>
                      <option value="aluno">Aluno</option>
                      <option value="mentor">Mentor</option>
                      <option value="admin">Admin</option>
                    </select>
                    <input className="input" type="password" placeholder="Senha" value={password} onChange={(e)=>setPassword(e.target.value)} />
                    <input className="input" type="password" placeholder="Confirmar senha" value={confirm} onChange={(e)=>setConfirm(e.target.value)} />
                  </>
                )}
                {mode === 'login' && (
                  <>
                    <input className="input" placeholder="Email" value={email} onChange={(e)=>setEmail(e.target.value)} />
                    <select className="input" value={role} onChange={(e)=>setRole(e.target.value)}>
                      <option value="aluno">Aluno</option>
                      <option value="mentor">Mentor</option>
                      <option value="admin">Admin</option>
                    </select>
                    <input className="input" type="password" placeholder="Senha" value={password} onChange={(e)=>setPassword(e.target.value)} />
                  </>
                )}
                {error && <span className="login-error">{error}</span>}
                <div className="login-actions">
                  <button className="btn btn-full" type="submit">
                    {mode === 'login' ? 'Entrar' : 'Criar Conta'}
                  </button>
                  <div className="login-switch">
                    {mode === 'login' ? (
                      <button className="btn" type="button" onClick={()=>{ setError(''); setMode('register'); }}>Criar Conta</button>
                    ) : (
                      <button className="btn" type="button" onClick={()=>{ setError(''); setMode('login'); }}>Já tenho conta</button>
                    )}
                  </div>
                </div>
              </form>
            </div>
          </div>
        );
      }

      function App() {
        const [user, setUser] = useState(() => {
          try { return JSON.parse(localStorage.getItem('gl_user') || 'null'); } catch { return null; }
        });

        const handleLogin = (u) => {
          setUser(u);
          localStorage.setItem('gl_user', JSON.stringify(u));
        };
        const handleLogout = () => {
          setUser(null);
          localStorage.removeItem('gl_user');
        };

        if (!user) return <LoginForm onLogin={handleLogin} />;

        return (
          <>
            <Header title="Gestão de Lideranças" user={user} onLogout={handleLogout} />
            {user.role === 'admin' ? (
              <AdminDashboard />
            ) : user.role === 'mentor' ? (
              <MentorApprovalSection />
            ) : (
              <StudentDonationsSection user={user} />
            )}
          </>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
